# 抽奖系统的实现

### demo 运行

VSCode + Code Runer 扩展
```sh
Run Code
Stop Code Run
```

### 抽奖系统的业务难点
 
* 抽奖的业务需求，既复杂有多变
* 奖品类型和概率设置
* 如何保证公平的抽奖，安全的发奖？

### 抽奖系统的技术挑战

* 网络并发编程，数据读写的并发安全性问题
* 高效的抽奖和发奖，提高并发和性能
* 系统优化，怎么把 redis 更好的利用起来

### Go vs PHP/JAVA

* 高并发，Go 协程优于 PHP 多进程，JAVA 多线程模式
* 高性能，编译后的二进制优于PHP解释型，JAVA 虚拟机
* 高效网络模型，epoll 优于 PHP BIO，JAVA 的 NIO

### 6 种抽奖活动

* 年会抽奖
* 彩票刮奖
* 微信摇一摇
* 支付宝集福卡
* 微博墙抢红包
* 抽奖大转盘

### 系统设计

* 需求/流程
* 数据库/架构

### 项目实战

* 框架/核心代码 
* 后台功能
* mysql版本
* 优化-使用redis
* 发奖计划与奖品池

### 演示和总结

* 合理设置奖品
* 合理发放奖品
* 压力测试
* 更多运营策略

### 引入 thrift 框架

* 设计接口
* 生成代码
* 服务端接口
* 客户端程序

### 6 种抽奖活动来一遍

#### 年会抽奖程序-annualMeeting

* 需求：导入全公司员工名单，`每次随机抽取出来一个人`
* 未知：有一等奖，二等奖，也有领导`临时`增加的产品
* 年会抽奖不涉及并发，但抽奖程序还是要考虑并发安全性问题

编写web单元测试和并发安全问题

* import "sync"
  - wg := sync.WaitGroup{}
    - wg.Add(1)
    - wg.Done()
    - wg.Wait()
  
用互斥锁解决并发安全问题

* import "sync"
- var mu sync.Mutex 
- mu = sync.Mutex{}

在 `/import` & `/lucky` 加上 `mu.Lock()` & `defer mu.Unlock()`

所有的并发都会在同一个共享变量读写的地方进行排队，而不是各自进行读写

#### 彩票刮奖-ticket

* 即开即得型，挂挂乐，随机尾号数字
* 定时开奖型，双色球，随机7位数字
* 稳赚，技术难度谁做谁谁知道
  - 可以通过数学准确的计算出抽奖概率的，只要参与的人数足够多

两个功能
1. 即开即得型
2. 双色球自选型

#### 微信摇一摇-wechatShake

* 人、歌曲、电视、`奖品`，种类多，数量多
* 随机匹配奖品，针对虚拟币、虚拟券、实物等，不一样的发奖规则
* 中奖后，减库存，记录并且提示用户。考虑`线程安全性问题`

`/lucky` 只有一个抽奖接口

定义枚举：奖品类型，枚举值 iota 从 0 开始

压力测试

```sh
wrk -t10 -c10 -d5 http://localhost:8080/lucky
# -t: 线程数
# -c: 连接数
# -d: 持续时间

wc -l lottery_demo.log # 查看文件有多少行

echo "" > lottery_demo.log # 清空下数据
```

检测性能和并发安全问题(超卖问题！！！)--> 简单解决-》sync.Mutex

#### 支付宝集福卡-alipayFu

* 奖品是虚拟的5个福字，没有数量限制
* 先识别图片，确定福字的获得概率
* 不存在线程安全问题
* 概率来自于图片扫描，动态的设置

```sh
wrk -t10 -c10 -d5 http://localhost:8080/lucky?uid=1&rate=4,3,2,1,0
wc -l lottery_demo.log
echo "" > lottery_demo.log
```

