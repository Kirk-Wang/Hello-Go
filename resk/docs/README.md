# [3小时极简春节抢红包之Go的实战](https://www.imooc.com/learn/1101) 笔记📒

### 红包资金交易秒杀系统架构设计

* 需求分析方法和用例定义方法
* 四色建模法和核心模型设计
* 系统架构设计
* 数据库物理模型设计
* Golang编程实践
* 资金交易安全问题探讨
* 超卖问题的解决方案
* 表结构设计中的性能优化考虑
* 红包拆解和红包算法
* 系统设计和算法的选择

### 红包系统演进之路

* 满足红包业务需求，快速迭代上线
* 出现超卖现象，事务锁来帮忙
* 流量增加，收红包出现性能瓶颈，改为乐观锁，性能提高3倍
* 流量继续增加，乐观锁也扛不住了，那就上缓存吧
* 缓存还没跑溜，服务器挂了，数据丢失了？
* 分布式消息队列来解决异步写？
* 数据分片来解决数据库横向扩展？

### 课程能学到什么？

1. 红包业务系统的需求分析方法和用例定义方法
2. 学习四色建模法的基本知识，并结合红包业务场景把需求转化为业务模型来深入学习四色建模方法
3. 学习在四色建模法建模过程中如何绘制时间抽事件模型图？
4. 通过业务模型如何来拆分业务系统模块？然后通过业务模型来学习如何定义业务边界？
5. 从业务模型和架构目标和愿景来学习架构设计过程、设计方法？
6. 学习如何从业务模型推到物理模型？
7. 如何从数据库物理模型设计上和系统架构设计上来优化性能？
8. 如何解决资金交易安全（超卖）问题和资金交易上性能优化？并结合超卖方案来学习使用 Golang 编程语言来做基准测试
9. 如何在不同的场景和时机中设计和应用红包算法
10. 学习 Golang 项目如何构建？
11. 在 Golang 中如何设计和解决基础公共资源的访问问题？
12. 学习使用 Golang 接口来设计基础资源加载和启动的基础设施组件，学习对基础资源组件生命周期的管理的设计？

### 红包业务场景

* 场景概述
* 场景分析
* 用例分析和定义：发、收（抢、摇）红包

#### 场景概述

场景分类：祝福、庆祝、营销、显摆、曝光、求问等。

#### 场景分析

* 有发红包，就有收红包。
* 发红包
  * 普通红包
    * 固定的数量和每个红包的金额
  * 碰运气红包
    * 固定的数量和红包的总金额
* 收红包
  * `抢`和`摇`两种（后端本质上它们是一样的）
    * `摇` 红包可能要借助手机📱等相关设备来完成互动
    * `摇` 红包的流量是不确定的

简短描述下业务流程：

购买了`红包`产品，发布`红包`产品的过程。

红包发送者从红包中间商购买一定数量和一定金额的红包，然后赠送出去。赠送就是发布商品的过程，赠送的对象就是红包发送者选定的目标人或人群。

收红包就是商品的秒杀活动，抢`红包发送者`发送的红包，目标人群中有人会抢到红包。`红包受益人`将红包金融产品交给`红包中间商`兑换面值并转换为金额，然后存入个人钱包账户

#### 用例定义和分析方法概述

**用例定义的主要元素**

* 用例名称
  - 需求的名称
* 场景概述
  - 一句话需求，是谁？在哪里？什么时候？做了什么事情？产生了什么结果？
* 用例描述
  - 业务流程(1,2,3,4,5)
* 用例价值（可选，老板说的，客户要的，不会去分析相关价值）
  - 需求的价值。
* 约束和限制（可选）
  - 限制红包数量，金额
  - 法律的要求等……

红包业务分为 4 类业务场景：
  - 发红包
  - 收红包
    - 抢
    - 摇
  - 用户的资金账户

#### 发红包业务场景概述

场景概述

* 按红包类型：普通红包和碰运气红包
  * 普通红包：数量和单个金额固定
  * 碰运气红包：数量和总金额固定

单向红包 & 群发红包

#### 发红包业务场景用例定义

**正常逻辑定义--正确发送**

  * 场景：用户发一定数量和金额的红包给`1个`或`多个`人（一句话需求）
  * 用例描述（6步）
    1. 用户选择红包的接受人，目标人群
    2. 用户确定红包的类型，`普通` 还是 `碰运气` 红包，设定红包的金额和数量
    3. 后端系统接受到请求，计算和验证发送的总金额和数量
    4. 从中间商那里购买红包，其实就是后台系统实时生成红包的，`红包中间商` 只是一个虚拟的角色
    5. 用户支付红包商品总金额给 `系统中间商`，系统从用户账户中扣除红包商品总金额
    6. 将红包商品的秒杀活动发布出来
  * 约束限制
    1. 合法用户
    2. 红包总金额(100)
    3. 红包的总数量(100)

**异常逻辑定义1-用户余额不足**

* 场景：当用户发红包时，账户余额不足
* 用例描述
  * 支付过程中，验证后出现的
* 约束限制：余额不小于红包总金额

**异常逻辑定义2-红包未接收**

* 场景：当用户发送红包后，红包未被接收过期
* 用例描述
  1. 用户正确发布红包商品的秒杀链接
  2. 部分红包被接收，部分红包未被接收
  3. 系统把余额退回红包发放者
* 约束限制：超过24个小时

#### 收红包业务场景用例分析

接收红包目标：
  1. 单向红包
  2. 群发红包

接收红包方式：
  1. 抢红包
  2. 摇红包

**正常逻辑定义-抢到红包**

* 场景：当用户点击红包链接后，抢到红包，金额存入账户
* 用例描述
* 约束限制：合法用户，群内用户

**异常逻辑定义-未抢到红包**

* 场景：当用户点击红包链接后，未抢到红包
* 用例描述
  - 用户点击红包，进入秒杀流程。系统检测库存不足，提示用户再接再厉
* 约束限制

#### 摇红包业务场景概述

摇红包场景
  - 和抢红包的异同 [特殊情况][流程一致]
  - 摇红包 [终端][量多][持续][不确定]
  - 用例定义和抢红包差不太多

#### 红包资金账户业务需求

**`满足用户发红包和收红包业务过程中`**

**`用于红包资金的交易和记账`**

资金交易：

- 交易需求：账户、余额
- 记账和对账：纪录资金交易过程和行为
- 交易的参与者：交易主体和交易对象

#### 红包业务场景总结

`红包是小额金融产品：充值卡、购物卡`

* 发红包：从中间商购买和发布
* 收红包：秒杀、兑换

`红包资金账户满足用于红包业务资金的交易和记账`

### 红包业务场景概要设计

**`模型分析概述`**
  - 四色建模法介绍
  - 红包业务总体模型分析和设计

**`子业务模型设计`**
  - 红包资金账户模型分析和设计
  - 发红包模型分析和设计
  - 收红包模型分析和设计

**`数据库设计，编码的基础`**

### 四色建模法介绍

#### 四色建模法-四个概念

**`时标性对象-时刻时段原型`**
  - 业务在时间轴上发生的需要跟踪的 `事件` 留下的 `痕迹`
  - 图例用 `粉色` 来标识

**`实体对象`**
  - 业务事件中的参与者：人、事、物
  - 图例用 `绿色` 表示

**`角色`**
  - 实体在业务流程中所扮演的角色
  - 图例用 `黄色` 表示

**`描述`**
  - 说明实体、时标性对象的属性
  - 图例用 `蓝色` 来标识

#### 四色建模法-五步骤

  - 第一步：寻找需要追溯的 `事件和足迹`，识别出 `时标性对象`。
  - 第二步：整理时标对象，得到 `模型骨干`
  - 第三步：寻找和分析出这些事件中的参与者：`人、事、物`
  - 第四步：抽象出`角色`，并插入其中
  - 第五步：添加对象 `描述性` 信息

#### 第一步：追溯事件和痕迹👣

  以业务事件发生的时间顺序，找出事件和痕迹

    怎么找？人、时间、地点串联起来，找出故事证据
    谁，在什么时候，在哪里，对(为)谁，做了什么事情，获得了什么收益？
  

完整步骤：[模型分析](./hb-5-model.png)

红包业务模型：
  - 资金账户模型：账户、流水、用户
  - 红包模型：红包、秒杀活动、流转、库存、用户